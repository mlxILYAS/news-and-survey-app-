{% extends 'base.html' %}

{% block title %}{{ article.title }}{% endblock %}

{% block back_button %}
<div class="mb-3">
    <a href="{% url 'news:home' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Home
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container mt-3">

    <!-- Flipboard-like Hero Header -->
    <section class="hero-article mb-4">
        <div class="hero-left">
            <div class="d-inline-flex align-items-center gap-2 small text-warning mb-2">
                <i class="fas fa-book-open"></i>
                <span>Storyboard</span>
            </div>

            <h1 class="display-5 fw-bold mb-2">{{ article.title }}</h1>

            {% if article.excerpt %}
                <p class="lead text-white-50 mb-4">{{ article.excerpt }}</p>
            {% endif %}

            <div class="d-flex align-items-center gap-3 mb-3">
                <div class="rounded-circle border border-warning d-flex align-items-center justify-content-center" style="width:40px;height:40px;background:rgba(255,255,255,0.05);">
                    <i class="fas fa-compass text-info"></i>
                </div>
                <div class="small text-white-75">
                    Curated by <span class="fw-semibold">{{ article.author }}</span>
                    <span class="ms-2 text-white-50"><i class="fas fa-calendar-alt me-1"></i>{{ article.published_at|date:'M d, Y' }}</span>
                </div>
            </div>


            <div class="d-flex flex-wrap gap-3 mt-2 small text-white-50">
                <span><i class="fas fa-clock me-1"></i>{{ reading_time }} min read</span>
                <span><i class="fas fa-pen-nib me-1"></i>{{ word_count }} words</span>
            </div>

            <div class="d-flex align-items-center gap-4 mt-3">
                <span class="hero-action"><i class="far fa-heart me-2"></i>1</span>
                <span class="hero-action"><i class="fas fa-plus me-2"></i></span>
                <span class="hero-action"><i class="fas fa-share-alt me-2"></i></span>
                <span class="ms-auto text-white-50 small"><i class="fas fa-eye me-1"></i>{{ article.views }}</span>
            </div>
        </div>

        <div class="hero-right {% if not article.image %}no-image{% endif %}" {% if article.image %}style="background-image:url('{{ article.image.url }}');"{% endif %}></div>
    </section>

    <!-- Reading progress -->
    <div class="read-progress mb-3"><div id="readProgressBar" class="read-progress-bar"></div></div>

    <div class="row">
        <div class="col-lg-8">
            <div class="row">
                <div class="col-auto d-none d-lg-block">
                    <div class="share-rail position-sticky" style="top: 100px;">
                        <button class="rail-btn" type="button" onclick="toggleLike(this)" aria-label="Like"><i class="far fa-heart"></i></button>
                        <button class="rail-btn" type="button" onclick="shareOrCopy(this)" aria-label="Share"><i class="fas fa-share-alt"></i></button>
                        <button class="rail-btn" type="button" onclick="copyLink(this)" aria-label="Copy link"><i class="fas fa-link"></i></button>
                    </div>
                </div>
                <div class="col">
                    <!-- Main Article Body -->
                    <article class="mb-5">
                        <div id="articleBody" class="article-content">
                            {{ article.content|linebreaks }}
                        </div>
                    </article>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Sidebar -->
            <div class="position-sticky" style="top: 2rem;">
                <!-- Related Articles -->
                {% if related_articles %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">More from {{ article.author }}</h5>
                        </div>
                        <div class="card-body">
                            {% for related in related_articles %}
                                <div class="mb-3 pb-3 border-bottom">
                                    <h6 class="mb-1">
                                        <a href="{% url 'news:article_detail' related.slug %}" class="text-decoration-none">
                                            {{ related.title }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">{{ related.published_at|date:'M d, Y' }}</small>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Quick Actions -->
                {% if user.is_authenticated %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="{% url 'news:article_create' %}" class="btn btn-success btn-sm">Write Article</a>
                                <a href="{% url 'news:survey_create' %}" class="btn btn-info btn-sm">Create Survey</a>
                                {% if user.is_superuser %}
                                    <a href="{% url 'news:article_delete' article.slug %}" class="btn btn-danger btn-sm">
                                        <i class="fas fa-trash me-1"></i>Delete Article
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
(function(){
  // Reading progress
  const bar = document.getElementById('readProgressBar');
  const body = document.getElementById('articleBody');
  function updateProgress(){
    if(!bar || !body) return;
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const start = body.offsetTop - 100; // start after hero
    const totalScrollable = (body.offsetTop + body.scrollHeight) - window.innerHeight;
    const progress = Math.max(0, Math.min(1, (scrollTop - start) / Math.max(1, (totalScrollable - start))));
    bar.style.width = (progress * 100).toFixed(2) + '%';
  }
  window.addEventListener('scroll', updateProgress, {passive:true});
  window.addEventListener('resize', updateProgress);
  setTimeout(updateProgress, 250);


  // Share & copy
  window.copyLink = async function(btn){
    try{
      await navigator.clipboard.writeText(location.href);
      btn.classList.add('copied');
      setTimeout(()=>btn.classList.remove('copied'), 1200);
    }catch(e){}
  };
  window.shareOrCopy = async function(btn){
    const shareData = { title: document.title, url: location.href };
    if (navigator.share){
      try { await navigator.share(shareData); } catch(e){}
    } else {
      window.copyLink(btn);
    }
  };
  window.toggleLike = function(btn){
    const i = btn.querySelector('i');
    if(!i) return;
    if (i.classList.contains('far')) {
      i.classList.remove('far'); i.classList.add('fas'); btn.classList.add('copied');
    } else {
      i.classList.remove('fas'); i.classList.add('far'); btn.classList.remove('copied');
    }
  };
})();
</script>
{% endblock %}